{% extends "open_base.html" %}
{% block titlecontainer %}
<div class="w3-10"></div>
<div class="w3-80">
{% endblock %}

{% block titleheader %}
  Video events {{ valgt_klasse }}
{% endblock %}

{% block headercontainer %}Video events {{ valgt_klasse }} <img id=header_icon src="../static/icon_photos.png"> {% endblock %}

{% block titlemain %}
  <img id=menu_icon src="../static/icon_photos.png"> Video events {{ valgt_klasse }}
{% endblock %}

{% block menuitems %}
  <li class=dropdown id=topborder>
    <a href=javascript:void(0) class=dropbtn>Velg klasse</a>
    <div class=dropdown-content>
      <a href=video_events?klasse=&event_id={{ event_id }}>Alle video events</a>
      {% for klasse in raceclasses %}
        {% for ac_name in klasse.ageclasses %}
          <a href=video_events?klasse={{ klasse.name }}&event_id={{ event_id }}>{{ ac_name }}</a>
        {% endfor %}
      {% endfor %}
    </div>
  </li>
{% endblock %}

{% block content %}
  <script>
    /* this function will send results to backend without reloading the page */
    function import_new_events(button) {
      document.getElementById(button.id).innerHTML = " Sender... ";
      document.getElementById(button.id).disabled = true;
      var xhttp = new XMLHttpRequest();
      xhttp.open("POST", "/video_events", true);
      xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

      var my_form = button.form;
      var formData = "";
      for (let i = 0; i < my_form.length; i++) {
        formData += my_form[i].name + "=" + my_form[i].value + "&";
      }
      formData += "event_id={{ event_id }}&action=service_bus"

      xhttp.send(formData);
      xhttp.onload = function() {
        try {
          // load new info
          document.getElementById("info_result").innerHTML = this.response;
          document.getElementById(button.id).innerHTML = " Hent nye events ";
          document.getElementById(button.id).disabled = false;
        }
        catch(err) {
          if (err.message.indexOf("401") > 0) {
            alert("Error 401 - Logg inn på nytt.");
          }
          else {
            alert(err);
          }
        }
      }
    }

    /* this function will pull events from queue without reloading the page */
    function pull_events(button) {
      try {
        document.getElementById(button.id).innerHTML = " Henter... ";
        document.getElementById(button.id).disabled = true;
        var max_lengt_info = 600;
        var old_info = document.getElementById("pull_result").innerHTML;
        if (old_info.length > max_lengt_info) {
          old_info = old_info.substring(0, max_lengt_info);
        }

        // get current time, hours, minutes
        var d = new Date();
        var current_time = d.toLocaleTimeString();

        var xhttp = new XMLHttpRequest();
        xhttp.open("POST", "/video_events", true);
        xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

        var formData = "";
        formData += "action=pull_google&event_id={{ event_id }}"

        xhttp.send(formData);
        xhttp.onload = function() {
          try {
            // load new info
            const info = this.response;
            document.getElementById("pull_result").innerHTML = current_time + " - " + info + "<br>" + old_info;
            document.getElementById(button.id).innerHTML = " Hent events ";
            document.getElementById(button.id).disabled = false;
          }
          catch(err) {
            if (err.message.indexOf("401") > 0) {
              alert("Error 401 - Logg inn på nytt.");
            }
            else {
              document.getElementById("pull_result").innerHTML = err;
              document.getElementById(button.id).innerHTML = " Hent events ";
              document.getElementById(button.id).disabled = false;
              alert(err);
            }
          }
        }
      }
      catch(err) {
          document.getElementById(button.id).innerHTML = " Hent events ";
          document.getElementById(button.id).disabled = false;
          alert(err);
        }
        return false; // avoid to execute the actual submit of the form.
      }

  </script>

  <table>
    <tr>
      <td align=center>
        <button type="button" id="pull_events_button" onclick="pull_events(this);" > Hent events </button>
      </td>
    </tr>
    <tr height="500">
      <td id="orange" valign="top">
        <span id="pull_result"></span>
      </td>
  </tr>
</table>
{% endblock %}
</div>
