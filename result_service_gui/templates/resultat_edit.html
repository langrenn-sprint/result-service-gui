{% extends "open_base.html" %}
{% block stylesheet %}
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
{% endblock %}
{% block titlecontainer %}<div class="w3-container">{% endblock %}

{% block titleheader %}
  Registrer resultat {{ valgt_runde.klasse }} {{ valgt_runde.runde }}
{% endblock %}

{% block headercontainer %}Registrer resultat {{ valgt_klasse }} <img id=header_icon src="../static/icon_timing.png"> {% endblock %}

{% block refresh %}{% endblock %}

{% block titlemain %}
  <img id=menu_icon src="../static/icon_timing.png"> Registrer resultat {{ valgt_runde.klasse }}
  {% if valgt_runde.runde == "Q" %}Kvartfinaler
  {% elif valgt_runde.runde == "S" %}Semifinaler
  {% elif valgt_runde.runde == "F" %}Finaler
  {% endif %}
{% endblock %}

{% block menuitems %}
  <li class=dropdown id=topborder>
    <a href=javascript:void(0) class=dropbtn>Velg runde</a>
    <div class=dropdown-content>
      <table>
        <tr><td colspan="4">
            <a href=resultat_edit?event_id={{ event_id }}&heat=0>Starter nå</a>
        </td></tr>
        {% if current_races %}
          <tr><td colspan="2">
            <nobr><a href=resultat_edit?event_id={{ event_id }}&heat={{ (current_races|first).order - 1 }}>Forrige runde</a></nobr>
          </td><td colspan="2">
            <nobr><a href=resultat_edit?event_id={{ event_id }}&heat={{ (current_races|last).order + 1 }}>Neste runde</a></nobr>
          </tr>
        {% endif %}
        {% for raceclass in raceplan_summary %}
          {% if raceclass.ranking %}
          <tr>
            <td id="black">{{ raceclass.name }}</td>
            <td><nobr><a href=resultat_edit?event_id={{ event_id }}&klasse={{ raceclass.name }}&runde=Q>Kvart</a></nobr></td>
            <td><nobr><a href=resultat_edit?event_id={{ event_id }}&klasse={{ raceclass.name }}&runde=S>Semi</a></nobr></td>
            <td><nobr><a href=resultat_edit?event_id={{ event_id }}&klasse={{ raceclass.name }}&runde=F>Finale</a></nobr></td>
          </tr>
          {% endif %}
        {% endfor %}
      </table>
    </div>
  </li>
{% endblock %}

{% block content %}
  <div id=spacer></div>
  <script>
    function checkform(form) {
      try {
        // Change the "Submit" text
        form.submit_update.value = 'Vennligst vent...';
        form.submit_update.disabled = true;
        return true
      }
      catch(err) {
        return true
      }
    }
    
    /* this function will send results to backend without reloading the page */
    function update_results_ajax(button) {
      try {
        document.getElementById(button.id).innerHTML = " Sender... ";
        document.getElementById(button.id).disabled = true;
        var xhttp = new XMLHttpRequest();
        xhttp.open("POST", "/resultat_edit", true);
        xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

        var my_form = button.form;
        var formData = "";
        var race_order = 0
        for (let i = 0; i < my_form.length; i++) {
          formData += my_form[i].name + "=" + my_form[i].value + "&";
          if (my_form[i].name == "race_order"){
            race_order = my_form[i].value
          }
        }
        formData += "ajax=true"

        xhttp.send(formData);
        xhttp.onload = function() {
          try {
            // load new info
            const jsonDoc = JSON.parse(this.response);
            const race_results = jsonDoc.race_results;
            const race_results_status = jsonDoc.race_results_status;

            // refresh data - first delete
            for (let i = 0; i < 12; i++) {
              try { 
                document.getElementById(race_order + "_name_" + i).innerHTML = ""
                document.getElementById(race_order + "_form_rank_" + i).value = ""
                document.getElementById(race_order + "_old_form_rank_" + i).value = ""
                document.getElementById(race_order + "_time_event_id_" + i).value = ""
              }
              catch(err) {}
            }
            // refresh data - set updated info
            for (let i = 0; i < race_results.length; i++) {
              /* do the stuff */
              document.getElementById(race_order + "_name_" + race_results[i].rank).innerHTML = race_results[i].name
              document.getElementById(race_order + "_form_rank_" + race_results[i].rank).value = race_results[i].bib
              document.getElementById(race_order + "_old_form_rank_" + race_results[i].rank).value = race_results[i].bib
              document.getElementById(race_order + "_time_event_id_" + race_results[i].rank).value = race_results[i].id
            }
            const info = jsonDoc.informasjon.replace("<br>", ", ");
            validation_colors(race_order);
            if (race_results_status == 2) {
              document.getElementById(race_order + "_status").innerHTML = " - resultat publisert."
            }
            document.getElementById(race_order + "_result").innerHTML = info;
            document.getElementById(race_order + "_result_toggle").innerHTML = "(Skjul) ";
            document.getElementById(button.id).innerHTML = " Lagre ";
            document.getElementById(button.id).disabled = false;
          }
          catch(err) {
            if (err.message.indexOf("401") > 0) {
              alert("Error 401 - Logg inn på nytt.");
            }
            else {
              document.getElementById(race_order + "_result").innerHTML = err;
              alert(err);
            }
            document.getElementById(button.id).innerHTML = " Lagre ";
            document.getElementById(button.id).disabled = false;
          }
        }
        // get dns status for next heat
        let next_race = 1 + parseInt(race_order)
        update_dns(next_race)
      }
      catch(err) {
        alert(err)
      }
    }

    /* this function will update dns field for given race when triggered
    */
    function update_dns(race_order) {
      var xhttp = new XMLHttpRequest();
      var url = "/timing_info?action=DNS&event_id={{ event_id }}&race_order=" + race_order;
      xhttp.open("GET", url, true);
      xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

      xhttp.send();
      xhttp.onload = function() {
        try { 
            // load new info
            const jsonDoc = JSON.parse(this.response);
            const dns_list = new Array(jsonDoc.dns_list);

            dns_list[0].forEach(myFunction);
            function myFunction(value, index, array) {
              var myId = race_order.toString() + value + "_start_status"
              document.getElementById(myId).innerHTML = "DNS"
            }
          }
          catch(err) {}
        }
      }
 
    /* this function will update value of checkbox when clicked
    */
    function update_checkbox(box, race_order) {
      if (box.checked) {
        document.getElementById(race_order + "_publish").value = "true"
      } else  {
        document.getElementById(race_order + "_publish").value = "false"
      }
    }

    /* this function will indicate with red or green colors if entered values are correct or not
      if bib exist in heat, the bib will be green,
      if bib not exist in heat or it is a duplicate, the entered value will be red 
    */
      function validation_colors(race_order) {
        // 1. reset all colors
        for (let i = 0; i < 12; i++) {
          try { 
            document.getElementById(race_order + "_form_rank_" + i).style.backgroundColor = "";
          }
          catch(err) {}
          try { 
            const old_bib = document.getElementById(race_order + "_old_form_rank_" + i).value;
            document.getElementById(race_order + old_bib).style.backgroundColor = "";
          }
          catch(err) {}
        }
        // 2. collect entered data, reset on start-entries and find dupliactes
        const bib_array = []
        const duplicate_array = []
        for (let i = 0; i < 12; i++) {
          try { 
            const new_bib = document.getElementById(race_order + "_form_rank_" + i).value;
            if (new_bib != "") {
              if (bib_array.indexOf(new_bib) > -1) {
                duplicate_array.push(new_bib)
              } else {
                bib_array.push(new_bib);
              }
            }
          }
          catch(err) {}
        }
        // 3. set red on duplicate bibs (values)
        duplicate_array.forEach(myDuplicateFunction);
        function myDuplicateFunction(value, index, array) {
          for (let i = 0; i < 12; i++) {
            try { 
              if (value == document.getElementById(race_order + "_form_rank_" + i).value) {
                document.getElementById(race_order + "_form_rank_" + i).style.backgroundColor = "red";
              }
            } catch(err) {}
          }
        }
        // 4. set green on start-entries and red on bibs (values) not in start list
        bib_array.forEach(myStartColorFunction);
        function myStartColorFunction(value, index, array) {
          for (let i = 0; i < 12; i++) {
            try { 
                document.getElementById(race_order + value).style.backgroundColor = "green";
            }
            catch(err) {
              for (let i = 0; i < 12; i++) {
                try { 
                  if (value == document.getElementById(race_order + "_form_rank_" + i).value) {
                    document.getElementById(race_order + "_form_rank_" + i).style.backgroundColor = "red";
                  }
                } catch(err) {}
              }
            }
          }
        }

      }

    function dnf_toggle(bib, race_name, race_order, race_id, checked) {
      console.log("DNS for bib: " + bib);
      var xhttp = new XMLHttpRequest();
      xhttp.open("POST", "/resultat_update", true);
      xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhttp.send("bib=" + bib + "&event_id={{ event_id }}&race=" + race_name + "&race_id=" + race_id + "&action=dnf&checked=" + checked);
      xhttp.onload = function() {
        document.getElementById(race_order + "_result").innerHTML = this.responseText;
        document.getElementById(race_order + bib).style.backgroundColor = "Grey";
      }
    }

  </script>
  {% for info in info_list %}
    <div class="w3-container" id=info>{{ info }}</div>
  {% endfor %}
  <div class="w3-container" id=info>{{ valgt_runde.informasjon }}</div>

<div class="w3-row-padding">
  {% for race in current_races %}
    <div id=headercollapse>
      {{ race.raceclass }}{{ race.round }}{{ race.index }}
      {% if race.round != "F" %}{{ race.heat }}{% endif %}
      &nbsp;kl {{ race.start_time[-8:] }} (heat {{ race.order }})
      <span id="{{ race.order }}_status">
        {% if race.results.Finish and (race.results.Finish.status == 2) %}
          - resultat publisert. 
        {% elif not race.startliste %}
          - ingen deltakere.          
        {% endif %}
      </span>
      <a data-toggle="collapse" href="#demo_{{ race.order }}">Vis/skjul.</a>
    </div>
    <div id=spacer></div>
    <div id="demo_{{ race.order }}" class="collapse in">
      <table>
        <tr id=headerblack>
          <td colspan=3>Startliste</td>
          <td colspan=2></td>
          <td colspan=2 id=resultheaderfirst>Resultater</td>
          <td colspan=2 id=resultheader align=center>{{ race.next_race }}</td>
          <td id=resultheader>Bilder</td>
        </tr>
        <tr>
          <th width=40>Pos</th>
          <th width=40>Nr</th>
          <th width=40>DNF</th>
          <th width="250">&nbsp;Navn</th>
          <th width="200">Klubb</th>
          <th width=50 id=resultborder>Plass</th>
          <th width=80>Startnr</th>
          <th width=250>Navn</th>
          <th>
            {% if valgt_runde.runde != "F" %}
              Videre til
            {% endif %}
          </th>
          <th></th>
        </tr>
        <form action=/resultat_edit method=post onsubmit="return checkform(this);">
          {% for start in race.startliste %}
            <tr>
              <td align="center">{{ start.starting_position }}</td>
              <td id="{{ race.order }}{{ start.bib }}" align="center">{{ start.bib }}</td>
                <td align="center">
                  <span id="{{ race.order }}{{ start.bib }}_start_status">
                    {% if start.start_status in ["DNS", "DNF"] %}
                      <a href="control?event_id={{ event_id }}&action=c&heat={{ race.raceclass }}-{{ race.round }}{{ race.index }}{{ race.heat }}">{{ start.start_status }}</a>
                      <script>document.getElementById({{ race.order }}{{ start.bib }}).style.backgroundColor = "Grey";</script>
                    {% else %}
                      <input type=checkbox id="dnf_{{ start.bib }}" onclick="dnf_toggle('{{ start.bib }}', '{{ race.raceclass }}-{{ race.round }}{{ race.index }}{{ race.heat }}', '{{ race.order }}', '{{ race.id }}', this.checked);">
                    {% endif %}
                  </span>
                  {% for bilde in race.photo_start %}
                    {% if start.bib in bilde.biblist %}
                    <a class="tooltip_photo_left">
                      &nbsp;<img src={{ bilde.g_base_url }}=w30-h25-c>
                        <span>
                            <img src="{{ bilde.g_base_url }}=w900-h900" title="Photo time: {{ bilde.creation_time[-8:] }}">
                        </span>
                    </a></td>
                    {% endif %}
                  {% endfor %}
                </td>
                <td>&nbsp;{{ start.name }}</td>
                <td>{{ start.club }}</td>
                <td id=resultborder align=center>{{ loop.index }}</td>
                {% if race.finish_timings[loop.index0] %}
                  <td>
                    <input type="text" id="{{ race.order }}_form_rank_{{ loop.index }}" name="{{ race.order }}_form_rank_{{ loop.index }}" value="{% if race.finish_timings[loop.index0].bib > 0 %}{{ race.finish_timings[loop.index0].bib }}{% endif %}" size=3 onfocus="this.oldvalue = this.value;" onchange="validation_colors({{ race.order }})">
                    <input type="hidden" id="{{ race.order }}_old_form_rank_{{ loop.index }}" name="{{ race.order }}_old_form_rank_{{ loop.index }}" value="{% if race.finish_timings[loop.index0].bib > 0 %}{{ race.finish_timings[loop.index0].bib }}{% endif %}">
                    <input type="hidden" id="{{ race.order }}_time_event_id_{{ loop.index }}" name="{{ race.order }}_time_event_id_{{ loop.index }}" value="{{ race.finish_timings[loop.index0].id }}">
                  </td>
                  <td id="{{ race.order }}_name_{{ loop.index }}">{{ race.finish_timings[loop.index0].name }}</td>
                  <td>
                    {% if valgt_runde.runde != "F" %}
                      {{ race.finish_timings[loop.index0].next_race }}-{{ race.finish_timings[loop.index0].next_race_position }}
                    {% endif %}
                  </td>
                {% else %}
                  <td>
                    <input type="text" id="{{ race.order }}_form_rank_{{ loop.index }}" name="{{ race.order }}_form_rank_{{ loop.index }}" value="" size=3 onfocus="this.oldvalue = this.value;" onchange="validation_colors({{ race.order }})">
                    <input type="hidden" id="{{ race.order }}_old_form_rank_{{ loop.index }}" name="{{ race.order }}_old_form_rank_{{ loop.index }}" value="">
                    <input type="hidden" id="{{ race.order }}_time_event_id_{{ loop.index }}" name="{{ race.order }}_time_event_id_{{ loop.index }}" value="">
                  </td>
                  <td id="{{ race.order }}_name_{{ loop.index }}"></td>
                  <td></td>
                {% endif %}
                {% if loop.first %}
                  <script>
                    /* populate_rank: populate race rank based upon analysis of photos
                      */
                    function populate_rank_{{ race.order }}() {
                      biblist = {{ race.photo_bib_rank }};
                      for (let i = 0; i < biblist.length; i++) {
                          position = i + 1;
                          the_element = "{{ race.order }}_form_rank_" + position;
                          document.getElementById(the_element).value = biblist[i];
                      }
                      validation_colors({{ race.order }});
                    }
                  </script>
                  <td rowspan="{{ loop.length }}">
                    <table><tr>
                    {% for bilde in race.photo_finish %}
                      {% if loop.first %}
                        <td colspan=5><button type="button" name="button" onclick="populate_rank_{{ race.order }}()">Hent resultat fra bilder</button></td></tr><tr>
                      {% endif %}
                      <td width=100><a class="tooltip_photo" href="">
                        <img src={{ bilde.g_base_url }}=w100-h100-c>
                         <span>
                             <img src="{{ bilde.g_base_url }}=w900-h900" tabindex=99><br>
                             <div id=headerblack>Photo time: {{ bilde.creation_time[-8:] }} Bibs: {{ bilde.biblist }}</div>
                         </span>
                      </a></td>
                      {% if loop.index is divisibleby(4) %}<td></td></tr><tr>{% endif %}
                    {% endfor %}
                    </tr></table>
                  </td>
                {% endif %}
            </tr>
            <script>
              validation_colors("{{ race.order }}")
            </script>
          {% endfor %}
            <tr>
              <td colspan=6></td>
              <td colspan=5>
                <input type="hidden" name="race" value="{{ race.raceclass }}-{{ race.round }}{{ race.index }}{{ race.heat }}">
                <input type="hidden" name="race_id" value="{{ race.id }}">
                <input type="hidden" name="race_order" value="{{ race.order }}">
                <input type="hidden" name=runde value="{{ valgt_runde.runde }}">
                <input type="hidden" name=klasse value="{{ valgt_runde.klasse }}">
                <input type="hidden" name=timing_point value="Finish">
                <input type="hidden" name=event_id value="{{ event_id }}">
                <input type="hidden" name=update_result value="true">
                <input type="hidden" name=submit_update value="  Lagre  " >
                <button type="button" id="{{ race.order }}_button" onclick=update_results_ajax(this); >Lagre</button>
                &nbsp;<input type="checkbox" id={{ race.order }}_publish name=publish value="true" checked onchange="update_checkbox(this, {{ race.order }});"> Publisere
              </td>
            </tr>
          </form>
          {% if race.startliste %}
            <tr>
              <form action=/resultat_edit method=post>
                <td colspan=5>
                  <input type="text" name="starting_position" value="" size=3>
                  <input type="text" name="bib" value="" min=1 max=9999 size=3>
                  <input type="submit" name=create_start value=" Legg til ">
                  <input type="hidden" name="race_id" value="{{ race.id }}">
                  <input type="hidden" name="startlist_id" value="{{ race.startliste[0].startlist_id }}">
                  <input type="hidden" name="start_time" value="{{ race.start_time }}">
                  <input type="hidden" name=runde value="{{ valgt_runde.runde }}">
                  <input type="hidden" name=klasse value="{{ valgt_runde.klasse }}">
                  <input type="hidden" name=event_id value="{{ event_id }}">
                </td>
              </form>
              <td colspan=6 id="orange">
                <a data-toggle="collapse" id="{{ race.order }}_result_toggle" href="#demo_{{ race.order }}"></a><span id="{{ race.order }}_result"></span>
              </td>
            </tr>
          {% endif %}
        </table>
      </div>
    {% endfor %}
    <table>
      <tr>
        <td>
        </td>
        {% if valgt_runde.runde == "F" %}
          <td width=300>
            <ul>
              <li class=dropdown>
                <a href=javascript:void(0) class=dropbtn>Utskrift</a>
                <div class=dropdown-content>
                  <a target=_blank href=print_lists?event_id={{ event_id }}&action=round_result&klasse={{ valgt_runde.klasse }}&runde={{ valgt_runde.runde }}>Rundens resultater</a>
                  <a target=_blank href=print_lists?event_id={{ event_id }}&action=result&klasse={{ valgt_runde.klasse }}&runde={{ valgt_runde.runde }}>Klassens resultatliste</a>
                </div>
              </li>
            </ul>
        {% else %}
          <td width=300>
            <ul>
              <li class=dropdown>
                <a href=javascript:void(0) class=dropbtn>Utskrift</a>
                <div class=dropdown-content>
                  <a target=_blank href=print_lists?event_id={{ event_id }}&action=round_result&klasse={{ valgt_runde.klasse }}&runde={{ valgt_runde.runde }}>Rundens resultater</a>
                  <a target=_blank href=print_lists?event_id={{ event_id }}&action=round_resultstart&klasse={{ valgt_runde.klasse }}&runde={{ valgt_runde.runde }}>Rundens resultater og nye startlister</a>
                  <a target=_blank href=print_lists?event_id={{ event_id }}&action=round_start&klasse={{ valgt_runde.klasse }}&runde={{ valgt_runde.runde }}>Nye startlister</a>
                </div>
              </li>
            </ul>
          </td>
        {% endif %}
        <td width=200>
          {% if current_races %}
            <nobr>
              <a href=resultat_edit?event_id={{ event_id }}&heat={{ (current_races|first).order - 1 }}>&nbsp;Forrige runde</a>
              <a href=resultat_edit?event_id={{ event_id }}&heat={{ (current_races|last).order + 1 }}>&nbsp;Neste runde</a>
            </nobr>
          {% endif %}
          </td>
      </tr>
    </table>
</div>
{% endblock %}
