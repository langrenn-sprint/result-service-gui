{% extends "open_base.html" %}
{% block stylesheet %}
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
{% endblock %}
{% block titlecontainer %}<div class="w3-container">{% endblock %}

{% block titleheader %}
  Registrer resultat {{ valgt_runde.klasse }} {{ valgt_runde.runde }}
{% endblock %}

{% block headercontainer %}Registrer resultat {{ valgt_klasse }} <img id=header_icon src="../static/icon_timing.png"> {% endblock %}

{% block refresh %}{% endblock %}

{% block titlemain %}
  <img id=menu_icon src="../static/icon_timing.png"> Registrer resultat {{ valgt_runde.klasse }}
  {% if valgt_runde.runde == "Q" %}Kvartfinaler
  {% elif valgt_runde.runde == "S" %}Semifinaler
  {% elif valgt_runde.runde == "F" %}Finaler
  {% endif %}
{% endblock %}

{% block menuitems %}
  <li class=dropdown id=topborder>
    <a href=javascript:void(0) class=dropbtn>Velg runde</a>
    <div class=dropdown-content>
      <a  href=resultat_edit?event_id={{ event_id }}&heat=0>Starter n√•</a>
      {% if current_races %}
          <a href=resultat_edit?event_id={{ event_id }}&heat={{ (current_races|first).order - 1 }}>Forrige runde</a>
          <a href=resultat_edit?event_id={{ event_id }}&heat={{ (current_races|last).order + 1 }}>Neste runde</a>
      {% endif %}
      {% for raceclass in raceplan_summary %}
        {% if raceclass.ranking %}
          <a href=resultat_edit?event_id={{ event_id }}&klasse={{ raceclass.name }}&runde=Q>{{ raceclass.name }} kvart</a>
          <a href=resultat_edit?event_id={{ event_id }}&klasse={{ raceclass.name }}&runde=S>{{ raceclass.name }} semi</a>
          <a href=resultat_edit?event_id={{ event_id }}&klasse={{ raceclass.name }}&runde=F>{{ raceclass.name }} finaler</a>
        {% endif %}
      {% endfor %}
    </div>
  </li>
{% endblock %}

{% block content %}
  <div id=spacer></div>
  <script>
    function checkform(form) {
      try {
        // Change the "Submit" text
        form.submit_update.value = 'Vennligst vent...';
        form.submit_update.disabled = true;
        return true
      }
      catch(err) {
        return true
      }
    }
    
    /* this function will send results to backend without reloading the page */
    function update_results_ajax(button) {
      try {
        var xhttp = new XMLHttpRequest();
        xhttp.open("POST", "/resultat_edit", true);
        xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

        var my_form = button.form;
        var formData = "";
        for (let i = 0; i < my_form.length; i++) {
          formData += my_form[i].name + "=" + my_form[i].value + "&";
        }
        formData += "ajax=true"

        xhttp.send(formData);
        xhttp.onload = function() {
            alert(this.responseText);
          }
      }
      catch(err) {
        alert(err)
      }
    }


    /* this function will indicate with red or green colors if an entered value is correct or not
      if bib exist in heat, the bib will be green,
      if bib not exist in heat or it is a duplicate, the entered value will be red */
     function green_bg(my_element, order_index) {
        try {
          old_element = order_index + my_element.oldvalue;
          // reset old value
          if (my_element.style.backgroundColor != "red") {
  	        document.getElementById(old_element).style.backgroundColor = "";
          }
          else {
  	        my_element.backgroundColor = "";
          }
        }
        catch(err) {
        }
        try {
          new_element = order_index + my_element.value;
           // check for duplicate, if not update
          if (document.getElementById(new_element).style.backgroundColor == "green") {
  	        my_element.style.backgroundColor = "red";
          }
          else {
          	document.getElementById(new_element).style.backgroundColor = "green";
          	my_element.style.backgroundColor = "";
          }
        }
        catch(err) {
          if (my_element.value != "") {
            my_element.style.backgroundColor = "red";
          }
        }
      }
      function green_bg_init(id) {
          document.getElementById(id).style.backgroundColor = "green";
      }
  </script>
  {% for info in info_list %}
    <div class="w3-container" id=info>{{ info }}</div>
  {% endfor %}

<div class="w3-row-padding">
  {% for race in current_races %}
    <div id=headercollapse>
      {{ race.raceclass }}{{ race.round }}{{ race.index }}
      {% if race.round != "F" %}{{ race.heat }}{% endif %}
      &nbsp;kl {{ race.start_time[-8:] }} (heat {{ race.order }})
      {% if race.results.Finish and (race.results.Finish.status == 2) %}
          - resultat publisert. <a data-toggle="collapse" href="#demo_{{ race.id }}">Vis/skjul.</a></div>
          <div id=spacer></div>
          <div id="demo_{{ race.id }}" class="collapse in">
      {% elif not race.startliste %}
          - ingen deltakere.<a data-toggle="collapse" href="#demo_{{ race.id }}">Vis/skjul.</a></div>
          <div id=spacer></div>
          <div id="demo_{{ race.id }}" class="collapse">
      {% else %}
        </div>
        <div id="demo_{{ race.id }}" class="collapse in">
      {% endif %}
      <table>
        <tr id=headerblack>
          <td colspan=3>Startliste</td>
          <td colspan=2></td>
          <td colspan=2 id=resultheaderfirst>Resultater</td>
          <td colspan=2 id=resultheader align=center>{{ race.next_race }}</td>
          <td id=resultheader>Bilder</td>
        </tr>
        <tr>
          <th width=40>Pos</th>
          <th width=40>Nr</th>
          <th></th>
          <th>&nbsp;Navn</th>
          <th>Klubb</th>
          <th id=resultborder>Plass</th>
          <th align=center>Startnr</th>
          <th>Navn</th>
          <th>
            {% if valgt_runde.runde != "F" %}
              Videre til
            {% endif %}
          </th>
          <th></th>
        </tr>
        <form action=/resultat_edit method=post onsubmit="return checkform(this);">
          {% for start in race.startliste %}
            <tr>
              <td align="center">{{ start.starting_position }}</td>
              <td id="{{ race.order }}{{ start.bib }}" align="center">{{ start.bib }}</td>
                <td>
                  {{ start.start_status }}
                  {% for bilde in race.photo_start %}
                    {% if start.bib in bilde.biblist %}
                    <a class="tooltip_photo_left">
                      &nbsp;<img src={{ bilde.g_base_url }}=w30-h25-c>
                        <span>
                            <img src="{{ bilde.g_base_url }}=w900-h900" title="Photo time: {{ bilde.creation_time[-8:] }}">
                        </span>
                    </a></td>
                    {% endif %}
                  {% endfor %}
                </td>
                <td>&nbsp;{{ start.name }}</td>
                <td>{{ start.club }}</td>
                <td id=resultborder align=center>{{ loop.index }}</td>
                {% if race.finish_timings[loop.index0] %}
                  <td>
                    <input type="text" id="{{ race.order }}form_rank_{{ loop.index }}" name="form_rank_{{ loop.index }}" value="{% if race.finish_timings[loop.index0].bib > 0 %}{{ race.finish_timings[loop.index0].bib }}{% endif %}" size=3 onfocus="this.oldvalue = this.value;" onchange="green_bg(this, {{ race.order }})">
                    <input type="hidden" name="old_form_rank_{{ loop.index }}" value="{% if race.finish_timings[loop.index0].bib > 0 %}{{ race.finish_timings[loop.index0].bib }}{% endif %}">
                    <input type="hidden" name="time_event_id_{{ loop.index }}" value="{{ race.finish_timings[loop.index0].id }}">
                  </td>
                  <td>{{ race.finish_timings[loop.index0].name }}</td>
                  <td>
                    {% if valgt_runde.runde != "F" %}
                      {{ race.finish_timings[loop.index0].next_race }}-{{ race.finish_timings[loop.index0].next_race_position }}
                    {% endif %}
                  </td>
                {% else %}
                  <td>
                    <input type="text" id="{{ race.order }}form_rank_{{ loop.index }}" name="form_rank_{{ loop.index }}" value="" size=3 onfocus="this.oldvalue = this.value;" onchange="green_bg(this, {{ race.order }})">
                    <input type="hidden" name="old_form_rank_{{ loop.index }}" value="">
                  </td>
                  <td></td>
                  <td></td>
                {% endif %}
                {% if loop.first %}
                  <script>
                    /* populate_rank: populate race rank based upon analysis of photos
                      */
                    function populate_rank_{{ race.order }}() {
                      biblist = {{ race.photo_bib_rank }};
                      for (let i = 0; i < biblist.length; i++) {
                          position = i + 1;
                          the_element = "{{ race.order }}form_rank_" + position;
                          document.getElementById(the_element).value = biblist[i];
                        try {
                          green_bg_init("{{ race.order }}" + biblist[i]);
                        }
                        catch(err) {
                          document.getElementById(the_element).style.backgroundColor = "red";
                        }
                      }
                    }
                  </script>
                  <td rowspan="{{ loop.length }}">
                    <table><tr>
                    {% for bilde in race.photo_finish %}
                      {% if loop.first %}
                        <td colspan=5><button type="button" name="button" onclick=populate_rank_{{ race.order }}()>Hent resultat fra bilder</button></td></tr><tr>
                      {% endif %}
                      <td width=100><a class="tooltip_photo" href="">
                        <img src={{ bilde.g_base_url }}=w100-h100-c>
                         <span>
                             <img src="{{ bilde.g_base_url }}=w900-h900" tabindex=99><br>
                             <div id=headerblack>Photo time: {{ bilde.creation_time[-8:] }} Bibs: {{ bilde.biblist }}</div>
                         </span>
                      </a></td>
                      {% if loop.index is divisibleby(4) %}<td></td></tr><tr>{% endif %}
                    {% endfor %}
                    </tr></table>
                  </td>
                {% endif %}
            </tr>
            {% for result in race.finish_timings %}
              {% if result.bib == start.bib %}
                <script>
                  green_bg_init({{ race.order }}{{ result.bib }})
                </script>
              {% endif %}
            {% endfor %}
          {% endfor %}
            <tr>
              <td colspan=6></td>
              <td colspan=4>
                <input type="hidden" name="race" value="{{ race.raceclass }}-{{ race.round }}{{ race.index }}{{ race.heat }}">
                <input type="hidden" name="race_id" value="{{ race.id }}">
                <input type="hidden" name=runde value="{{ valgt_runde.runde }}">
                <input type="hidden" name=klasse value="{{ valgt_runde.klasse }}">
                <input type="hidden" name=timing_point value="Finish">
                <input type="hidden" name=event_id value="{{ event_id }}">
                <input type="hidden" name=update_result value="true">
                <input type="submit" name=submit_update value="  Lagre  " >
                &nbsp;<input type="checkbox" name=publish checked> Publisere
              </td>
            </tr>
          </form>
          {% if race.startliste %}
            <tr>
              <form action=/resultat_edit method=post>
                <td colspan=6>
                  <input type="text" name="starting_position" value="" size=3>
                  <input type="text" name="bib" value="" min=1 max=9999 size=3>
                  <input type="submit" name=create_start value=" Legg til ">
                  <input type="hidden" name="race_id" value="{{ race.id }}">
                  <input type="hidden" name="startlist_id" value="{{ race.startliste[0].startlist_id }}">
                  <input type="hidden" name="start_time" value="{{ race.start_time }}">
                  <input type="hidden" name=runde value="{{ valgt_runde.runde }}">
                  <input type="hidden" name=klasse value="{{ valgt_runde.klasse }}">
                  <input type="hidden" name=event_id value="{{ event_id }}">
                </td>
              </form>
              <td colspan=4>&nbsp;</td>
            </tr>
          {% endif %}
        </table>
      </div>
    {% endfor %}
    <table>
      <tr>
        <td>
        </td>
        {% if valgt_runde.runde == "F" %}
          <td width=300>
            <ul>
              <li class=dropdown>
                <a href=javascript:void(0) class=dropbtn>Utskrift</a>
                <div class=dropdown-content>
                  <a target=_blank href=print_lists?event_id={{ event_id }}&action=round_result&klasse={{ valgt_runde.klasse }}&runde={{ valgt_runde.runde }}>Rundens resultater</a>
                  <a target=_blank href=print_lists?event_id={{ event_id }}&action=result&klasse={{ valgt_runde.klasse }}&runde={{ valgt_runde.runde }}>Klassens resultatliste</a>
                </div>
              </li>
            </ul>
        {% else %}
          <td width=300>
            <ul>
              <li class=dropdown>
                <a href=javascript:void(0) class=dropbtn>Utskrift</a>
                <div class=dropdown-content>
                  <a target=_blank href=print_lists?event_id={{ event_id }}&action=round_result&klasse={{ valgt_runde.klasse }}&runde={{ valgt_runde.runde }}>Rundens resultater</a>
                  <a target=_blank href=print_lists?event_id={{ event_id }}&action=round_resultstart&klasse={{ valgt_runde.klasse }}&runde={{ valgt_runde.runde }}>Rundens resultater og nye startlister</a>
                  <a target=_blank href=print_lists?event_id={{ event_id }}&action=round_start&klasse={{ valgt_runde.klasse }}&runde={{ valgt_runde.runde }}>Nye startlister</a>
                </div>
              </li>
            </ul>
          </td>
        {% endif %}
        <td width=200>
        </td>
      </tr>
    </table>
</div>
{% endblock %}
